name: App install and start

concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: [ self-hosted ]

    steps:
      - uses: actions/checkout@v2
        with:
          clean: false

      - name: Run actions/setup-java@v2
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: 'adopt'  # JDK 배포자를 선택합니다.
          java-package: 'jdk'
          architecture: 'x64'
          check-latest: false
          server-id: 'github'
          server-username: ${{ github.actor }}
          server-password: ${{ github.token }}
          overwrite-settings: true
          job-status: 'success'

      - name: Stop old server (ignore error)
        run: |
          if [ -f server.pid ]; then
            SERVER_PID=$(cat server.pid)
            kill -15 $SERVER_PID || true
            rm server.pid
            echo "Old server with PID $SERVER_PID stopped"
          fi

      - name: Remove old server directory (ignore error)
        run: |
          rm -rf ~/source || true

      - name: Build Spring application
        run: |
          ./gradlew clean build -x test

      - name: Copy new server to ~/source
        run: |
          mkdir -p ~/source
          cp -R ~/Locomoco_BE/build/libs/locomoco-server-0.0.1-SNAPSHOT.jar ~/source # JAR 파일의 경로를 확인하여 수정

      - name: Start the server
        run: |
          nohup java -jar ~/source/locomoco-server-0.0.1-SNAPSHOT.jar > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          echo "Server started with PID $SERVER_PID"
